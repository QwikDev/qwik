---
phase: 01-environment-api-activation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/qwik/src/optimizer/src/plugins/vite.ts
autonomous: true

must_haves:
  truths:
    - "Dev server logs show Vite 7+ detected (version 7.3.1)"
    - "environments.client config exists with consumer: 'client'"
    - "environments.ssr config exists with consumer: 'server'"
    - "Plugin hooks receive this.environment in dev mode"
  artifacts:
    - path: ".planning/phases/01-environment-api-activation/01-01-VERIFICATION.md"
      provides: "Verification report documenting all checks"
      contains: "## Verification Results"
  key_links:
    - from: "vite.ts:getViteMajorVersion()"
      to: "environments config block"
      via: "version check >= 7"
      pattern: "viteMajorVersion >= 7"
---

<objective>
Validate that Vite 7+ Environment API is activated and configured correctly in the Qwik Vite plugin.

Purpose: Confirm the existing Environment API implementation works before validating dev/build behavior in subsequent phases.
Output: Verification report documenting all checks pass.
</objective>

<execution_context>
@/Users/jackshelton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jackshelton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/qwik/src/optimizer/src/plugins/vite.ts
@packages/qwik/src/optimizer/src/plugins/vite.unit.ts
@packages/qwik/src/optimizer/src/plugins/plugin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run existing Environment API unit tests</name>
  <files>packages/qwik/src/optimizer/src/plugins/vite.unit.ts</files>
  <action>
    Run the existing unit tests that verify Environment API configuration:

    1. Execute: `pnpm test.unit packages/qwik/src/optimizer/src/plugins/vite.unit.ts`
    2. Verify all tests pass, specifically:
       - "environments config should be present for Vite 7+"
       - "environments config should NOT be present for older Vite versions"
       - "environments config should NOT be present for undefined version (Rolldown)"
       - "client environment should have browser resolve conditions"
       - "ssr environment should have node resolve conditions"
       - All hotUpdate hook tests pass
    3. Document test results including any failures or warnings.

    The existing tests in the "Vite 7+ Environment API configuration" describe block (lines 668-737) already validate:
    - Version detection via `createConfigHookContext('7.0.0')`
    - Presence of environments.client and environments.ssr
    - Correct consumer values ('client' and 'server')
    - Resolve conditions per environment
  </action>
  <verify>
    All tests in vite.unit.ts pass with exit code 0.
    Test output shows "Vite 7+ Environment API configuration" tests passing.
  </verify>
  <done>
    Unit tests confirm Environment API activation logic is correct for Vite 7+ detection, legacy fallback, and environment configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify plugin hooks receive this.environment in dev mode</name>
  <files>packages/qwik/src/optimizer/src/plugins/plugin.ts</files>
  <action>
    Verify the `getIsServer()` function correctly uses `this.environment` when available:

    1. Review the `getIsServer()` function implementation (lines 444-457 in plugin.ts):
       - Confirm it checks `environment?.config?.consumer === 'server'` first
       - Confirm it falls back to `environment?.name === 'ssr'`
       - Confirm it uses opts.target fallback when no devServer/Environment API

    2. Run the plugin unit tests to verify hook behavior:
       `pnpm test.unit packages/qwik/src/optimizer/src/plugins/plugin.unit.ts`

    3. Check that hotUpdate hook tests verify environment-specific behavior:
       - Tests in vite.unit.ts lines 578-666 verify:
         - hotUpdate hook exists on post plugin
         - Skips non-client environments
         - Sends full-reload for client environment with modules
         - Uses this.environment.hot.send() for HMR

    4. Document which hooks use this.environment and confirm they work correctly.
  </action>
  <verify>
    Plugin unit tests pass.
    getIsServer() function checks environment.config.consumer first.
    hotUpdate tests verify this.environment.name and this.environment.hot.send() usage.
  </verify>
  <done>
    Plugin hooks correctly receive and use this.environment in dev mode, with proper fallback for legacy Vite versions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document verification results</name>
  <files>.planning/phases/01-environment-api-activation/01-01-VERIFICATION.md</files>
  <action>
    Create a verification report documenting all checks:

    1. Create `.planning/phases/01-environment-api-activation/01-01-VERIFICATION.md` with:
       - Summary of all verification checks performed
       - Test results from Task 1 and Task 2
       - ENV-01 status: Vite 7+ detected and environments config applied
       - ENV-02 status: server.environments.client and server.environments.ssr exist
       - ENV-03 status: this.environment available in plugin hooks
       - Any issues found and their severity
       - Legacy fallback path verification status

    2. Include specific evidence:
       - Test output excerpts showing pass/fail
       - Code line references confirming implementation
       - Version detection logic confirmation (getViteMajorVersion)

    3. Mark requirements as verified or note any gaps.
  </action>
  <verify>
    Verification report exists at specified path.
    Report contains all required sections.
    All ENV-* requirements have status documented.
  </verify>
  <done>
    Comprehensive verification report created documenting Environment API activation status and all checks passed.
  </done>
</task>

</tasks>

<verification>
1. All unit tests pass: `pnpm test.unit packages/qwik/src/optimizer/src/plugins/vite.unit.ts` exits 0
2. Plugin unit tests pass: `pnpm test.unit packages/qwik/src/optimizer/src/plugins/plugin.unit.ts` exits 0
3. Verification report exists with documented results
4. No test failures or regressions introduced
</verification>

<success_criteria>
- ENV-01: Confirmed - Unit tests verify Vite 7+ detection and environments config application
- ENV-02: Confirmed - Unit tests verify environments.client and environments.ssr exist with correct consumer values
- ENV-03: Confirmed - Code review and tests confirm this.environment usage in getIsServer() and hotUpdate hook
- All existing tests continue to pass
- Verification report created with evidence
</success_criteria>

<output>
After completion, create `.planning/phases/01-environment-api-activation/01-01-SUMMARY.md` using the summary template.
</output>
